---
import { z } from "zod";
import EstimateWrapper from "@layouts/EstimateWrapper.astro";
import { shortTradeEnum } from "@assets/info/estimateOptions";
import { ProcessEstimateType } from "@utils/kv/estimateTypeReset";
import { formSubmissionParser } from "be-rpc-estimates/src/zoddles/form-submission/formSubmissionType";
import StepLayout from "@components/step-layout/index.astro";
import { appendQueryParams } from "@utils/queryParams";

// Validation schemas
const zipSchema = formSubmissionParser.pick({ zipCode: true });
const estimateTypeSchema = shortTradeEnum;

interface PageState {
  estimateType: string;
  zipCode: string | null;
  city: string | null;
  state: string | null;
  stepNumber: number;
  totalSteps: number;
}

// Initialize page state
async function initializePage(
  params: Record<string, string | undefined>,
  searchParams: URLSearchParams,
  runtime: any
): Promise<PageState | Response> {
  // Validate estimate type from URL params
  const parsedEstimateType = estimateTypeSchema.safeParse(params.estimateType);

  if (!params.estimateType || !parsedEstimateType.success) {
    console.error("Invalid estimate type");
    return new Response(null, {
      status: 302,
      headers: { Location: "/" },
    });
  }

  const validatedEstimateType = parsedEstimateType.data;
  ProcessEstimateType(validatedEstimateType);

  // Get user location from Cloudflare
  const cfPostalCode = z.string().safeParse(runtime.cf?.postalCode);

  // Initialize zip code from URL param or Cloudflare location
  const zipCode =
    searchParams.get("zipCode") ||
    (cfPostalCode.success ? cfPostalCode.data : null);

  const city = searchParams.get("city") || null;
  const state = searchParams.get("state") || null;

  return {
    estimateType: validatedEstimateType,
    zipCode,
    city,
    state,
    stepNumber: 1, // Will be updated client-side
    totalSteps: 5, // Will be updated client-side
  };
}

// Handle form submission
async function handleFormSubmission(
  request: Request,
  estimateType: string,
  runtime: any
): Promise<Response | null> {
  const formData = await request.formData();
  const submission = {
    zipCode: formData?.get("zipInput") as string,
    trustedFormCertUrl: formData?.get("xxTrustedFormCertUrl") as string,
    trustedFormPingUrl: formData?.get("xxTrustedFormPingUrl") as string,
  };

  const parsedZip = zipSchema.safeParse({ zipCode: submission.zipCode });

  if (parsedZip.success) {
    const zipCode = parsedZip.data.zipCode;

    try {
      // Initialize ZIP service
      const zipService = await runtime.env.ZIP_METHODS.newZipMethods();
      const locationData = await zipService.uspsZipCheck(zipCode);

      if (!locationData?.defaultState || !locationData?.defaultCity) {
        throw new Error("Invalid ZIP code location data");
      }

      // Pass data as URL parameters
      const url = new URL(request.url);
      url.searchParams.set("zipCode", zipCode);
      url.searchParams.set("city", locationData.defaultCity);
      url.searchParams.set("state", locationData.defaultState);

      if (submission.trustedFormCertUrl) {
        url.searchParams.set(
          "trustedFormCertUrl",
          submission.trustedFormCertUrl
        );
      }

      if (submission.trustedFormPingUrl) {
        url.searchParams.set(
          "trustedFormPingUrl",
          submission.trustedFormPingUrl
        );
      }

      // The next step will be determined client-side
      const redirectUrl = `/estimate/${estimateType}/`;
      return new Response(null, {
        status: 302,
        headers: {
          Location: appendQueryParams(redirectUrl, url.searchParams),
        },
      });
    } catch (error) {
      console.error("ZIP validation error:", error);
      return new Response("Invalid ZIP code", {
        status: 400,
        statusText: "Invalid ZIP code or service unavailable",
      });
    }
  }

  return null;
}

// Process the page based on the request method
let pageState: PageState | Response;

if (Astro.request.method === "POST") {
  const result = await handleFormSubmission(
    Astro.request,
    Astro.params.estimateType || "",
    Astro.locals.runtime
  );
  if (result) {
    return result;
  }
}

pageState = await initializePage(
  Astro.params,
  Astro.url.searchParams,
  Astro.locals.runtime
);

if (pageState instanceof Response) {
  return pageState;
}

// Helper function to format estimate type display
const formatEstimateTypeNoun = (type: string) =>
  type.endsWith("s") ? type.slice(0, -1) : type;
---

<EstimateWrapper
  title={pageState.estimateType}
  estimateType={pageState.estimateType}
>
  <form method="post" id="zipForm" data-estimate-type={pageState.estimateType}>
    <StepLayout
      stepHeader={`Let's find your local ${formatEstimateTypeNoun(pageState.estimateType)} pros`}
      stepNumber={pageState.stepNumber}
      totalSteps={pageState.totalSteps}
      hasNextStep
      hasPrevStep={false}
      estimateType={pageState.estimateType}
      delaySubmit={true}
      loadingButtonText="Validating your zip code..."
    >
      <div class="flex flex-col gap-4 text-center rounded-lg container">
        <h2 class="text-xl font-black"></h2>

        <div
          class="flex flex-col items-start text-center gap-4 w-full mx-auto max-w-md"
        >
          <!-- Hidden TrustedForm fields -->
          <input type="hidden" name="xxTrustedFormCertUrl" />
          <input type="hidden" name="xxTrustedFormPingUrl" />

          <p class="text-[#111928] text-sm font-medium leading-[21px]">
            Enter the location of your project
          </p>

          <div class="w-full relative">
            <img
              src="/static/map-pin-alt.svg"
              alt="location pin"
              class="absolute left-4 top-1/2 -translate-y-1/2"
            />
            <input
              type="text"
              required
              id="zipInput"
              name="zipInput"
              placeholder="Enter your zip code"
              value={pageState.zipCode ?? null}
              class="w-full h-[52px] pl-14 pr-4 py-3.5 bg-gray-50 rounded-lg border border-gray-300 text-gray-500 text-base font-normal leading-normal"
              minlength="5"
              maxlength="5"
              pattern="[0-9]{5}"
              inputmode="numeric"
            />
          </div>
        </div>
      </div>
    </StepLayout>
  </form>
</EstimateWrapper>

<script>
  import { shortTradeEnum } from "@assets/info/estimateOptions";
  import { getNextStep } from "@consts/index";
  import { estimateStore } from "@stores/estimateProgress";
  import { estimateStepsStore } from "@stores/estimateStepsStore";
  import { crossPlatformLoader } from "@utils/crossPlatformLoader";
  import { z } from "zod";

  const ZIP_LENGTH = 5;

  const validators = {
    zipString: z.string().length(ZIP_LENGTH),
    zipNumber: z.coerce.number(),
  };

  class ZipFormValidator {
    private zipInput: HTMLInputElement;
    private submitButton: HTMLButtonElement;
    private form: HTMLFormElement;
    private estimateType: string;

    constructor() {
      this.zipInput = document.getElementById("zipInput") as HTMLInputElement;
      this.submitButton = document.getElementById(
        "nextStepButton"
      ) as HTMLButtonElement;
      this.form = document.getElementById("zipForm") as HTMLFormElement;
      this.estimateType =
        document
          .querySelector("[data-estimate-type]")
          ?.getAttribute("data-estimate-type") || "";

      if (
        this.zipInput &&
        this.submitButton &&
        this.form &&
        this.estimateType
      ) {
        this.initialize();
      }
    }

    private initialize() {
      const validatedEstimateType = shortTradeEnum.safeParse(this.estimateType);
      if (!validatedEstimateType.success) {
        console.error("Invalid estimate type");
        return;
      }

      // Initialize stores
      estimateStepsStore.set({
        currentStep: "zip",
        estimateType: validatedEstimateType.data,
      });

      // Check initial value
      if (this.zipInput.value) {
        const isValid =
          validators.zipString.safeParse(this.zipInput.value).success &&
          validators.zipNumber.safeParse(this.zipInput.value).success;

        this.toggleSubmitButton(isValid);
      }

      // Set up event listeners
      this.zipInput.addEventListener("input", (event) => {
        const input = (event.target as HTMLInputElement).value;
        this.validateZipCode(input);
      });

      // Handle form submission
      this.form.addEventListener("submit", (e) => this.handleSubmit(e));
    }

    private validateZipCode(input: string) {
      const isValid =
        validators.zipString.safeParse(input).success &&
        validators.zipNumber.safeParse(input).success;

      this.toggleSubmitButton(isValid);
    }

    private toggleSubmitButton(isValid: boolean) {
      if (isValid) {
        this.submitButton.setAttribute("aria-disabled", "false");
      } else {
        this.submitButton.setAttribute("aria-disabled", "true");
      }
    }

    private async handleSubmit(e: Event) {
      // We'll let the form submit to the server for ZIP validation
      // but we'll update the store with current values
      const existingStore = estimateStore.get();
      const formData = new FormData(this.form);

      // Get TrustedForm data
      const trustedFormCertUrl =
        document
          .querySelector('[name="xxTrustedFormCertUrl"]')
          ?.getAttribute("value") || "";
      const trustedFormPingUrl =
        document
          .querySelector('[name="xxTrustedFormPingUrl"]')
          ?.getAttribute("value") || "";

      // Update store with zipCode and estimateShortTrade
      estimateStore.set({
        ...existingStore,
        zipCode: this.zipInput.value,
        estimateShortTrade: this.estimateType,
        trackingParams: {
          ...existingStore.trackingParams,
          trustedFormCertUrl: trustedFormCertUrl || undefined,
          trustedFormPingUrl: trustedFormPingUrl || undefined,
        },
      });

      // Get next step
      const validatedEstimateType = shortTradeEnum.safeParse(this.estimateType);
      if (validatedEstimateType.success) {
        const nextStep = getNextStep(validatedEstimateType.data, "zip");
        if (nextStep) {
          const url = new URL(window.location.href);
          url.pathname = `/estimate/${this.estimateType}/${nextStep}`;

          // Add electric bill as URL parameter
          url.searchParams.set("zip", this.zipInput.value);

          window.location.href = url.toString();
          return;
        }
      }
    }
  }

  crossPlatformLoader(() => new ZipFormValidator());
</script>
