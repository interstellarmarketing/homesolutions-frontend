---
import { homeTypesConst, shortTradeEnum } from "@assets/info/estimateOptions";
import LargeRadioButtonGroup from "@components/radio-button/LargeRadioButtonGroup.astro";
import StepLayout from "@components/step-layout/index.astro";
import EstimateWrapper from "@layouts/EstimateWrapper.astro";
import { appendQueryParams } from "@utils/queryParams";
import { z } from "zod";
import { getCurrentStepNumber, getTotalSteps } from "@consts/estimateSteps";
// Schema definitions
const homeTypeSchema = z.enum(homeTypesConst);
const estimateTypeSchema = shortTradeEnum;

interface PageState {
  estimateType: string;
  tradeDescription: string | undefined;
  homeTypes: typeof homeTypesConst;
  currentSelection: string | undefined;
  stepNumber: number;
  totalSteps: number;
}

function initializePage(
  params: Record<string, string | undefined>,
  searchParams: URLSearchParams
): PageState | Response {
  const parsedEstimateType = estimateTypeSchema.safeParse(params.estimateType);

  if (!parsedEstimateType.success) {
    return new Response(null, { status: 302, headers: { Location: "/" } });
  }

  const estimateType = parsedEstimateType.data;
  const currentSelection = searchParams.get("homeType") || undefined;

  // Get step information
  const stepNumber = getCurrentStepNumber(estimateType, "home-type");
  const totalSteps = getTotalSteps(estimateType);

  return {
    estimateType,
    tradeDescription: undefined, // Will be set client-side
    homeTypes: homeTypesConst,
    currentSelection,
    stepNumber,
    totalSteps,
  };
}

async function handleFormSubmission(request: Request, estimateType: string) {
  const formData = await request.formData();
  const homeTypeParsed = homeTypeSchema.safeParse(formData.get("homeType"));

  if (!homeTypeParsed.success) {
    return null;
  }

  // Instead of using store, we'll pass the value as a URL parameter
  const url = new URL(request.url);
  url.searchParams.set("homeType", homeTypeParsed.data);

  // The next step will be determined client-side
  const redirectUrl = `/estimate/${estimateType}/`;
  return new Response(null, {
    status: 302,
    headers: {
      Location: appendQueryParams(redirectUrl, url.searchParams),
    },
  });
}

// Process the page based on the request method
let pageState: PageState | Response;
if (Astro.request.method === "POST") {
  const result = await handleFormSubmission(
    Astro.request,
    Astro.params.estimateType || ""
  );
  if (result) {
    return result;
  }
}

pageState = initializePage(Astro.params, Astro.url.searchParams);

if (pageState instanceof Response) {
  return pageState;
}

// These will be determined client-side
const stepNumber = 1;
const totalSteps = 5;
const stepHeader = "What type of home do you have?";
---

<EstimateWrapper
  title={pageState.estimateType}
  estimateType={pageState.estimateType}
>
  <form
    method="post"
    id="homeTypeForm"
    data-estimate-type={pageState.estimateType}
  >
    <input
      type="hidden"
      id="hasInitialSelection"
      value={pageState.currentSelection ? "true" : "false"}
    />

    <StepLayout
      stepHeader={stepHeader}
      stepNumber={pageState.stepNumber}
      totalSteps={pageState.totalSteps}
      hasNextStep={pageState.stepNumber < pageState.totalSteps}
      hasPrevStep={pageState.stepNumber > 1}
      estimateType={pageState.estimateType}
    >
      <LargeRadioButtonGroup
        options={pageState.homeTypes}
        name="homeType"
        currentSelection={pageState.currentSelection}
        layout="grid2"
        capitalize={true}
      />
    </StepLayout>
  </form>

  <script>
    import {
      homeTypesConst,
      shortTradeEnum,
      tradeOptionDescriptions,
      type ShortTradeEnum,
    } from "@assets/info/estimateOptions";
    import {
      getCurrentStepNumber,
      getNextStep,
      getTotalSteps,
    } from "@consts/estimateSteps";
    import { activeEstimateTypeStore } from "@stores/activeEstimateType";
    import { estimateStore } from "@stores/estimateProgress";
    import { estimateStepsStore } from "@stores/estimateStepsStore";
    import { crossPlatformLoader } from "@utils/crossPlatformLoader";

    class FormController {
      private radioButtons: NodeListOf<HTMLInputElement>;
      private submitButton: HTMLButtonElement | null;
      private form: HTMLFormElement | null;
      private estimateType!: ShortTradeEnum;

      constructor() {
        this.radioButtons = document.querySelectorAll('input[name="homeType"]');
        this.submitButton = document.getElementById(
          "nextStepButton"
        ) as HTMLButtonElement;
        this.form = document.getElementById("homeTypeForm") as HTMLFormElement;
        const rawEstimateType =
          document
            .querySelector("[data-estimate-type]")
            ?.getAttribute("data-estimate-type") || "";

        this.estimateType = rawEstimateType as ShortTradeEnum;

        this.initialize();
      }

      private initialize() {
        if (!this.submitButton || !this.radioButtons.length || !this.form)
          return;

        const validatedEstimateType = shortTradeEnum.safeParse(
          this.estimateType
        );
        if (!validatedEstimateType.success) {
          console.error("Invalid estimate type");
          return;
        }

        // Initialize stores
        estimateStepsStore.set({
          currentStep: "home-type",
          estimateType: this.estimateType,
        });

        // Set trade description
        const tradeOptions = tradeOptionDescriptions.find(
          (option) => option.shortTrade === activeEstimateTypeStore.get()
        );

        // Update step info
        const stepNumber = getCurrentStepNumber(this.estimateType, "home-type");
        const totalSteps = getTotalSteps(this.estimateType);
        document
          .querySelector("[data-step-number]")
          ?.setAttribute("data-step-number", String(stepNumber));
        document
          .querySelector("[data-total-steps]")
          ?.setAttribute("data-total-steps", String(totalSteps));

        const hasInitialSelection = document.getElementById(
          "hasInitialSelection"
        ) as HTMLInputElement;
        if (hasInitialSelection?.value === "true") {
          this.submitButton.setAttribute("aria-disabled", "false");
        }

        this.radioButtons.forEach((radio) => {
          radio.addEventListener("change", () => this.handleRadioChange());
        });

        this.form.addEventListener("submit", (e) => this.handleSubmit(e));
      }

      private handleRadioChange() {
        if (!this.submitButton) return;

        const isSelected = Array.from(this.radioButtons).some(
          (radio) => radio.checked
        );
        this.submitButton.setAttribute(
          "aria-disabled",
          !isSelected ? "true" : "false"
        );
      }

      private handleSubmit(e: Event) {
        e.preventDefault();

        const formData = new FormData(this.form!);
        const homeType = formData
          .get("homeType")
          ?.toString() as (typeof homeTypesConst)[number];

        if (homeType && homeTypesConst.includes(homeType)) {
          // Update store
          const existingStore = estimateStore.get();
          estimateStore.set({
            ...existingStore,
            homeType: homeType,
          });

          // Get next step
          const nextStep = getNextStep(this.estimateType, "home-type");
          if (nextStep) {
            const url = new URL(window.location.href);
            url.pathname = `/estimate/${this.estimateType}/${nextStep}`;

            // Add homeType as URL parameter
            url.searchParams.set("homeType", homeType);

            window.location.href = url.toString();
          } else {
            // Fallback logic
            const redirectPath =
              this.estimateType === "roofing"
                ? `/estimate/${this.estimateType}/credit-score`
                : `/estimate/${this.estimateType}/contact`;

            // Create URL to add parameters
            const url = new URL(window.location.origin + redirectPath);
            url.searchParams.set("homeType", homeType);

            window.location.href = url.toString();
          }
        }
      }
    }

    crossPlatformLoader(() => new FormController());
  </script>
</EstimateWrapper>
