---
import { z } from "zod";
import EstimateWrapper from "@layouts/EstimateWrapper.astro";
import { estimateStore } from "@stores/estimateProgress";
import {
	shortTradeEnum,
	tradeOptionDescriptions,
} from "@assets/info/estimateOptions";
import { homeTypesConst } from "@assets/info/estimateOptions";
import {
	activeEstimateTypeStore,
	computedEstimateOptions,
} from "@stores/activeEstimateType";

// Define validation schemas using Zod
const estimateTypeSchema = shortTradeEnum;
const homeTypeSchema = z.string();

interface PageState {
	estimateType: string;
	tradeDescription: string | undefined;
	homeTypes: typeof homeTypesConst;
	currentSelection: string | undefined;
}

function initializePage(params: Record<string, string | undefined>): PageState | Response {
	const parsedEstimateType = estimateTypeSchema.safeParse(params.estimateType);

    console.log({parsedEstimateType, page: 'home-type'})
	
	if (!parsedEstimateType.success) {
		return new Response(null, { status: 302, headers: { Location: '/' } });
	}

	const estimateType = parsedEstimateType.data;
	const activeEstimateOptions = computedEstimateOptions.get();

    console.log({activeEstimateOptions, page: 'home-type'})
	
	if (!activeEstimateOptions) {
		return new Response(null, { status: 302, headers: { Location: '/' } });
	}

	const tradeOptions = tradeOptionDescriptions.find(
		(option) => option.shortTrade === activeEstimateTypeStore.get()
	);

	return {
		estimateType,
		tradeDescription: tradeOptions?.typeDescription,
		homeTypes: homeTypesConst,
		currentSelection: estimateStore.get().homeType
	};
}

async function handleFormSubmission(request: Request, estimateType: string) {
	const formData = await request.formData();
	const homeTypeParsed = homeTypeSchema.safeParse(formData.get("homeType"));

	if (!homeTypeParsed.success) {
		return null;
	}

	const existingStore = estimateStore.get();
	estimateStore.set({
		...existingStore,
		homeType: homeTypeParsed.data,
	});

	return new Response(null, {
		status: 302,
		headers: { Location: `/estimate/${estimateType}/contact` }
	});
}

const pageState = initializePage(Astro.params);

if (pageState instanceof Response) {
	return pageState;
}

if (Astro.request.method === "POST") {
	const response = await handleFormSubmission(Astro.request, pageState.estimateType);
	if (response) return response;
}

---
<EstimateWrapper 
	title={pageState.estimateType} 
	estimateType={pageState.estimateType}
>
	<div class="flex flex-col gap-4 text-center border rounded-lg p-8 container">
		<h2 class="text-xl font-black">
			What type of home do you have?
		</h2>
		
		<form class="flex flex-col items-center text-center gap-4 my-4" method="post">
			<div class="grid grid-cols-2 gap-4 p-8">
				{pageState.homeTypes.map((homeType) => (
					<label class="inline-flex items-center">
						<input
							type="radio"
							name="homeType"
							checked={pageState.currentSelection === homeType}
							value={homeType}
							class="hidden peer"
						/>
						<span class="px-4 py-2 w-full rounded-md bg-gray-200 text-gray-700 cursor-pointer peer-checked:bg-blue-500 peer-checked:text-white transition-colors">
							{homeType}
						</span>
					</label>
				))}
			</div>

			<div class="flex gap-4 items-center">
				<a
					href="javascript:history.back()"
					class="rounded-lg px-6 py-2 border disabled:opacity-20"
				>
					prev
				</a>
				<button
					type="submit"
					id="actionSubmitButton"
					class="rounded-lg px-6 py-2 border disabled:opacity-20"
					disabled
				>
					next
				</button>
			</div>
		</form>
	</div>
</EstimateWrapper>

<script>
	class FormController {
		private radioButtons: NodeListOf<HTMLInputElement>;
		private submitButton: HTMLButtonElement | null;

		constructor() {
			this.radioButtons = document.querySelectorAll('input[name="homeType"]');
			this.submitButton = document.getElementById("actionSubmitButton") as HTMLButtonElement;
			this.initialize();
		}

		private initialize() {
			if (!this.submitButton || !this.radioButtons.length) return;

			this.radioButtons.forEach(radio => {
				radio.addEventListener("change", () => this.handleRadioChange());
			});
		}

		private handleRadioChange() {
			if (!this.submitButton) return;

			const isSelected = document.querySelector('input[name="homeType"]:checked');
			this.submitButton.disabled = !isSelected;
		}
	}

	new FormController();
</script>
