---
import { estimateStore } from "@stores/estimateProgress";

const certUrl = estimateStore.get().trackingParams?.trustedFormCertUrl;
const pingUrl = estimateStore.get().trackingParams?.trustedFormPingUrl;
---

<script>
  import { estimateStore } from "@stores/estimateProgress";

  // starts a loop with interval of 500ms
  var interval = setInterval(getCertUrl, 500);
  async function getCertUrl() {
    var certUrl =
      document.getElementsByName("xxTrustedFormCertUrl")[0] &&
      (
        document.getElementsByName(
          "xxTrustedFormCertUrl"
        )[0] as HTMLInputElement
      ).value;
    var pingUrl =
      document.getElementsByName("xxTrustedFormPingUrl")[0] &&
      (
        document.getElementsByName(
          "xxTrustedFormPingUrl"
        )[0] as HTMLInputElement
      ).value;
    // check if the certificate has been generated
    if (certUrl && pingUrl) {
      // Update the store with the new values directly
      const existingStore = estimateStore.get();
      const existingTrackingParams = existingStore.trackingParams || {};

      estimateStore.set({
        ...existingStore,
        trackingParams: {
          ...existingTrackingParams,
          trustedFormCertUrl: certUrl,
          trustedFormPingUrl: pingUrl,
        },
      });

      // stops the loop
      clearInterval(interval);
    }
  }

  (function () {
    var tf = document.createElement("script");
    tf.type = "text/javascript";
    tf.async = true;
    tf.src =
      ("https:" == document.location.protocol ? "https" : "http") +
      "://api.trustedform.com/trustedform.js?field=xxTrustedFormCertUrl&ping_field=xxTrustedFormPingUrl&l=" +
      new Date().getTime() +
      Math.random();
    var s = document.getElementsByTagName("script")[0];
    s.parentNode?.insertBefore(tf, s);
  })();
</script>
<noscript>
  <img src="https://api.trustedform.com/ns.gif" alt="" />
</noscript>
