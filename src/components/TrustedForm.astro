---
import { estimateStore } from "@stores/estimateProgress";

const certUrl = estimateStore.get().trackingParams?.trustedFormCertUrl;
const pingUrl = estimateStore.get().trackingParams?.trustedFormPingUrl;

console.log(certUrl, pingUrl);
---

<script>
  import { updateTrustedFormParams } from "@actions/estimateStore";

  // starts a loop with interval of 500ms
  var interval = setInterval(getCertUrl, 500);
  async function getCertUrl() {
    console.log("Getting cert url");
    var certUrl =
      document.getElementsByName("xxTrustedFormCertUrl") &&
      (
        document.getElementsByName(
          "xxTrustedFormCertUrl"
        )[0] as HTMLInputElement
      ).value;
    var pingUrl =
      document.getElementsByName("xxTrustedFormPingUrl") &&
      (
        document.getElementsByName(
          "xxTrustedFormPingUrl"
        )[0] as HTMLInputElement
      ).value;
    // check if the certificate has been generated
    if (certUrl && pingUrl) {
      // Update the store with the new values
      const formData = new FormData();
      formData.append("certUrl", certUrl);
      formData.append("pingUrl", pingUrl);

      const { data, error } = await updateTrustedFormParams({
        certUrl,
        pingUrl,
      });

      // logs the certificate to the console
      console.log(certUrl, pingUrl);
      // stops the loop
      clearInterval(interval);
    }
  }

  (function () {
    var tf = document.createElement("script");
    tf.type = "text/javascript";
    tf.async = true;
    tf.src =
      ("https:" == document.location.protocol ? "https" : "http") +
      "://api.trustedform.com/trustedform.js?field=xxTrustedFormCertUrl&ping_field=xxTrustedFormPingUrl&l=" +
      new Date().getTime() +
      Math.random();
    var s = document.getElementsByTagName("script")[0];
    s.parentNode?.insertBefore(tf, s);
  })();
  console.log("TrustedForm loaded");
</script>
<noscript>
  <img src="https://api.trustedform.com/ns.gif" alt="" />
</noscript>
